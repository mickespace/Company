# API设计规范

[TOC]

## `URL`部分

`URL`部分都小写，单词之间用下划线（_）分割，如`task/list_for_all`，`URL`按/从左至右分为若干个部分，第一个部分为功能点，依次往右为子功能点（可以没有），最后一个部分为动作，`URL`至少包含两部分：
`task/workflow/list`：`task`为任务管理模块，`workflow`为任务模块中的工作流管理模块，最后一个部分`list`表示获取所有工作流集合。

| 通用格式         | 说明         | 请求方式   |
| ------------ | ---------- | ------ |
| `xxx/list`   | 获取xxx集合    | `GET`  |
| `xxx/info`   | 获取xxx的详细信息 | `GET`  |
| `xxx/create` | 创建xxx      | `POST` |
| `xxx/add`    | 添加xxx      | `POST` |
| `xxx/update` | 更新xxx      | `POST` |
| `xxx/delete` | 删除xxx      | `POST` |



## 参数部分

* 参数部分单词首字母都大写，如`ProjectId`。
* 关于`Id`的命名规则，如果xxx功能中需要传入`Id`，则不需要命名为`xxxId`，直接命名为`Id`即可，如`task/delete`中传入的参数为`Id`，不要命名成`TaskId`；如果yyy功能中需要传入xxx功能的`Id`，则应命名为`xxxId`。
* 如果主键`Id`在`json`字符串中，一律用`_id`表示
* `UserToken` `SecurityKey`这些属性必须放在属性表中。
* `Json`字符串格式需要在`Visual Studio Code`中书写，先写内容，然后格式化，再写注释，然后格式化，最后复制到`md`文件中来。


* 属性的默认值如下表所示，属性表中的参数也要按照表中默认值来写：

| 属性类型   | 属性值                                    |
| ------ | -------------------------------------- |
| 唯一性的主键 | `"ObjectId"`                           |
| 字符串    | `"string"`                             |
| 整数     | `0` `1` `...`                          |
| 浮点数    | `0.0` `0.1` `...`                      |
| 日期     | `"/Date/"`                             |
| 布尔类型   | `true` `false`                         |
| 属性名    | `PropertyName{i}` 其中`{i}`为数字           |
| `GUID` | `GUID`                                 |
| 表达式    | `"[Expression]"`                       |
| 超链接    | `url` （数据库中统一存`FileId`,返回给用户时拼接成`Url`） |
| 流      | `multipart/form-data`                  |

* 可以用`"...": ""`表示省略的属性
* 如果是数组，则只需列出第一个元素，第二个元素用省略号代替，如下所示：

```json
[{
    "PropertyName": "Value"
}, {
    "...": ""
}]
```

* `API`的返回值必须为如下格式：

  ```json
  {
      "IsOk": false, //是否成功
      "Code": 0, //返回码
      "Message": "string", //返回的信息
      "Data": "{json}" //返回的数据，应为一个有效的json表达式
  }
  ```

> **查询类`API`**:

* 如果查询集合，则需要包含 `ListParams`参数，包含筛选、分页、排序、映射四个功能参数，其格式为：

```json
{
    "Search": "[Expression]", //筛选表达式，默认为空，表示不筛选
    "Page": { //分页，默认为空，表示不分页
        "Index": 0, //分页索引，*必填
        "Count": 0 //分页数量，*必填
    },
    "Sort": [{ //排序，默认为空数组，表示不排序
        "Property": "PropertyName", //第一个排序的属性名，*必填
        "Ascending": false //是否升序排序，如果为false，则降序排列，默认为true
    }, {
        "...": ""
    }],
    "Map": ["PropertyName1", "..."] //返回的属性映射数组,默认为空数组，表示返回所有属性
}
```

* 如果查询集合只需要包含一个功能参数，则参数表中应包含该功能的参数，如`Map`，格式为：

```json
["PropertyName1", "..."]
```

* 如果查询集合需要包含两个及以上的功能参数，则参数表中仍需要包含 `ListParams`参数。

> **修改类`API`**

* 如果需要提交数据的属性**个数不确定**或者**大于等于5**的，则作为`json`格式的字符串放在`Data`属性中，同时在注释中必须标明哪些属性是必填的，如果不是必填的，则需要说明默认值是什么，如：

  ```json
  {
      "ProjectId": "ObjectId", //项目Id，*必填
      "Name": "string", //流程名称，*必填
      "Description": "string", //流程描述，默认为null
      "Steps": [{ //*必填，步骤信息集合
              "Name": "string", //步骤名称，*必填
              "ExecDays": 0, //执行天数，默认为0，表示不限制
              "StepType": 0, //步骤类型：0-任务节点；1-开始节点；2-结束节点，*必填
              "CanGoBack": true, //能否回退，默认为false
              "Executors": ["ObjectId", "..."], //该步骤默认的执行人，默认为空数组
              "Notifiers": ["ObjectId", "..."], //该步骤默认的抄送人，默认为空数组
          }, {
              "...": ""
          }
      ],
      "Transfers": [{ //流程流向信息集合，*必填
              "FromStepIndex": 0, //流程起始的步骤索引，*必填
              "ToStepIndex": 1, //流程流向的步骤索引，*必填
          }
      ]
  }
  ```

* 如果是批量删除，则返回删除成功的集合

* 如果是批量更新，则返回更新成功的集合

* 如果是批量新增，则参数中需要加`Map`属性，返回添加成功的集合

* 如果批量添加或修改数据，数据所属的其它输入`Id`需要放在属性表中，其它数据放在`json`字符串中。如：

  | 参数          | 必选      | 类型       | 说明                   |
  | ----------- | ------- | -------- | -------------------- |
  | `UserToken` | `true`  | `string` | 用户令牌（包含用户Id及访问权限等信息） |
  | `ProjectId` | `true`  | `string` | 项目Id                 |
  | `Data`      | `true`  | `json`   | 单体数据内容，数组格式          |
  | `Map`       | `false` | `json`   | 返回的属性映射数组,可选         |

  `Data`格式为：

  ```json
  [{
      "Code": "XZL-A", //楼层编码,*必填
      "Name": "A栋", //名称*必填
      "Area": 30454.3, //建筑面积㎡*必填
      "Description": "" //描述
  }, {
      "...": ""
  }]
  ```